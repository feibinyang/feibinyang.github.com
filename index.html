<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="猪爸爸喜欢看技术、看动漫；猪妈妈喜欢化妆品、在做 UP 主；小宇喜欢汽车、还有佩奇。我们都有光明的未来。"><meta name="keywords" content="HTML,CSS,Javascript,Node,Vue,React"><meta name="author" content="feibinyang"><meta name="copyright" content="feibinyang"><title>哦猪爸爸回来啦 | 小宇之家</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">feibinyang</div><div class="author-info__description text-center">猪爸爸喜欢看技术、看动漫；猪妈妈喜欢化妆品、在做 UP 主；小宇喜欢汽车、还有佩奇。我们都有光明的未来。</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">1</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">小宇之家</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div><div id="site-info"><div id="site-title">小宇之家</div><div id="site-sub-title">哦猪爸爸回来啦</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/11/18/Input-With-Composition-For-React/">Input-With-Composition-For-React</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-19</time><div class="content"><h5 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h5><p>​    目前业界主流的 React UI 组件库中，<code>Input</code> 组件都没有实现是否感知输入法功能，但是这个功能在某些情况下是很有必要的，比如搜索框根据输入关键词实时搜索时，React 提供的合成事件 <code>onChange</code> 默认是感知输入法的，在输入过程中会产生很多【无效的输入值】（下文统一用【值】指代【输入值】）被提交到后台查询（参考下图），这些查询是没有意义的。合理情况应该是等输入完成时（即非输入法状态时），再把值提交到后台查询。</p>
<img src="/2020/11/18/Input-With-Composition-For-React/demo.png" class="">

<h5 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h5><p>​    首先浏览器为 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Glossary/input_method_editor">IME</a> 元素提供了 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/CompositionEvent">CompositionEvent</a> 来感知输入法输入过程，其提供了 <code>compositionstart/compositionupdate/compositionend</code> 三个事件，我们可以借助它们来控制何时把有效值传出去。</p>
<p>​    其次在 React 提供的<a target="_blank" rel="noopener" href="https://reactjs.org/docs/events.html#form-events">合成事件</a>中，<code>onChange</code> 一般用在受控组件中，它是感知输入法的，为了兼容处理，我们采用另外一个合成事件 <code>onInput</code>（从语义上来说也更贴切），并增加一个 <code>props(composition)</code> 用来设置当前是否要感知输入法，这是对 <code>onInput</code> 功能的增强，没有破坏它的语义。</p>
<p>​    于是我们可以采用 <code>composition/onInput 2</code> 个 props，并借助 <code>compositionstart/compositionend</code> 来作开关，根据设置是否感知输入法（默认为 <code>false</code>，不感知）来实时把对应的值传出去。</p>
<h5 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h5><p>​    首先我们需要调研 <code>CompositionEvent</code> 和 <code>InputEvent</code> 事件的调用时序，具体可以参考 <a target="_blank" rel="noopener" href="https://jsbin.com/nitamigabo/1/edit?html,js,console,output">demo</a>。这里直接贴上第三方结论.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; chrome: input(emit) -&gt; ... -&gt; compositionstart -&gt; compositionupdate -&gt; input(not emit) -&gt; compositionend(emit)</span><br><span class="line">&#x2F;&#x2F; firefox: input(emit) -&gt; ... -&gt; compositionstart -&gt; compositionupdate -&gt; compositionend(not emit) -&gt; input(emit)</span><br><span class="line">&#x2F;&#x2F; 可以归纳出：</span><br><span class="line">&#x2F;&#x2F;  紧跟 compositionupdate 后面的 input 不要往上 sync</span><br><span class="line">&#x2F;&#x2F;  紧跟 input 后面的 compositionend 往上 sync，即传值</span><br></pre></td></tr></table></figure>

<p>所以我们可以在 <code>compositionstart</code> 时打开开关，<code>compositionend</code> 时关掉开关并调用 <code>onInput</code> 回调传值。原生 <code>input</code> 事件回调中，通过开关来判断是否非输入法状态（即输入完成），从而决定是否调用 <code>onInput</code> 回调传值。</p>
<p>​    其次是【开关】怎么设置问题。在 <code>Class Component</code> 中可以通过实例属性来设置，但在 <code>Function Component</code> 中行不通。通过 <code>state</code> 来控制也是不行的，因为 <code>setState</code> 是异步的，这会导致 <code>input</code> 事件回调执行时开关还没打开，从而把值传出去了。后来参考 <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue/blob/52719ccab8fccffbdf497b96d3731dc86f04c1ce/src/platforms/web/runtime/directives/model.js#L131">vue</a> 里实现可以把开关放置在 <code>DOM</code> 元素上（<code>event.target</code>）。</p>
<p>​    最后设计 <code>Input</code> 组件结构，大致如下：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>默认值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>defaultValue</td>
<td>string</td>
<td></td>
<td>非受控默认值</td>
</tr>
<tr>
<td>value</td>
<td>String</td>
<td></td>
<td>受控值</td>
</tr>
<tr>
<td>composition</td>
<td>boolean</td>
<td>false</td>
<td>是否感知输入法</td>
</tr>
<tr>
<td>onChange</td>
<td>Function</td>
<td></td>
<td></td>
</tr>
<tr>
<td>onInput</td>
<td>Function</td>
<td></td>
<td>输入值，不感知输入法时只在非输入法状态调用</td>
</tr>
</tbody></table>
<p>​    最终实现点击<a target="_blank" rel="noopener" href="https://codesandbox.io/s/input-with-composition-9mk8r">这里</a>。一个简单的可感知输入法 <code>Input</code> 组件实现完成。</p>
<p><em>注意：因为 <code>vue</code> 内部对 <code>v-model</code> 的封装，导致 <code>vue</code> 组件中可能存在 <code>value</code> 值对不上问题。详情可参考<a target="_blank" rel="noopener" href="https://github.com/ecomfe/veui/blob/d20/packages/veui/src/components/Input.vue">链接</a>。</em></p>
<h5 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h5><p>​    之前没注意，这次看 MDN 时才发现原生 <code>input</code> 和 <code>change</code> 事件触发时机不一样（具体参考 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/input_event">input event</a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event">change event</a>）。总结就是 <code>input</code> 是在每次输入值变化时就触发，<code>change</code> 是在 <code>lose focus</code> 或是 <code>commit value</code> 后才触发。</p>
<p>[参考资料]：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/CompositionEvent">https://developer.mozilla.org/en-US/docs/Web/API/CompositionEvent</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/input_event">https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/input_event</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event">https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/ecomfe/veui/blob/d20/packages/veui/src/components/Input.vue">https://github.com/ecomfe/veui/blob/d20/packages/veui/src/components/Input.vue</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://reactjs.org/docs/events.html#form-events">https://reactjs.org/docs/events.html#form-events</a></p>
</li>
</ul>
</div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By feibinyang</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>